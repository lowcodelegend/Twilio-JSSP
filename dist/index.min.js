function e(e){return"https://api.twilio.com/2010-04-01/Accounts/"+encodeURIComponent(e)}function t(e,t,s){const o=new XMLHttpRequest;o.open(e,t);const r=function(e){if(typeof Buffer<"u")return Buffer.from(e,"utf-8").toString("base64");if(typeof btoa<"u")return btoa(e);var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let s,o,r,n,a,i,d,c="",u=0;for(;u<e.length;)s=e.charCodeAt(u++),o=e.charCodeAt(u++),r=e.charCodeAt(u++),n=s>>2,a=(3&s)<<4|o>>4,i=(15&o)<<2|r>>6,d=63&r,isNaN(o)?i=d=64:isNaN(r)&&(d=64),c+=t.charAt(n)+t.charAt(a)+t.charAt(i)+t.charAt(d);return c}(s.accountSid+":"+s.authToken);return o.setRequestHeader("Authorization","Basic "+r),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o}metadata={systemName:"com.yourcompany.twilio.sms",displayName:"Twilio SMS Broker",description:"Integrates with Twilio to send, fetch, list, and delete SMS messages.",configuration:{accountSid:{displayName:"Twilio Account SID",type:"string",required:!0},authToken:{displayName:"Twilio Auth Token",required:!0,type:"string"}}},ondescribe=async function({configuration:e}){postSchema({objects:{message:{displayName:"Message",description:"Represents an SMS message in Twilio.",properties:{sid:{displayName:"Message SID",type:"string"},to:{displayName:"To",type:"string"},from:{displayName:"From",type:"string"},body:{displayName:"Body",type:"string"},status:{displayName:"Status",type:"string"},dateSent:{displayName:"Date Sent",type:"string"},errorCode:{displayName:"Error Code",type:"string"}},methods:{send:{displayName:"Send Message",type:"create",inputs:["to","from","body"],outputs:["sid","status","dateSent","errorCode"]},get:{displayName:"Get Message",type:"read",inputs:["sid"],outputs:["sid","to","from","body","status","dateSent","errorCode"]},list:{displayName:"List Messages",type:"list",parameters:{to:{displayName:"To",type:"string"},from:{displayName:"From",type:"string"},dateSent:{displayName:"Date Sent",type:"string"}},outputs:["sid","to","from","body","status","dateSent","errorCode"]},delete:{displayName:"Delete Message",type:"delete",inputs:["sid"],outputs:[]}}}}})},onexecute=async function({objectName:s,methodName:o,parameters:r,properties:n,configuration:a,schema:i}){if("message"!==s)throw new Error("The object '"+s+"' is not supported.");await async function(s,o,r,n){switch(s){case"send":await async function(s,o){return new Promise(((r,n)=>{const a=t("POST",e(o.accountSid.toString())+"/Messages.json",o),i=["To="+encodeURIComponent(s.to.toString()),"From="+encodeURIComponent(s.from.toString()),"Body="+encodeURIComponent(s.body.toString())].join("&");a.onreadystatechange=function(){if(4===a.readyState)try{if(a.status<200||a.status>=300)throw new Error("Twilio send failed: "+a.status+" - "+a.responseText);const e=JSON.parse(a.responseText);postResult({sid:e.sid,status:e.status,dateSent:e.date_sent||"",errorCode:e.error_code?String(e.error_code):""}),r()}catch(e){n(e)}},a.send(i)}))}(o,n);break;case"get":await async function(s,o){return new Promise(((r,n)=>{if(!s.sid)throw new Error("sid is required.");const a=t("GET",e(o.accountSid.toString())+"/Messages/"+encodeURIComponent(s.sid.toString())+".json",o);a.onreadystatechange=function(){if(4===a.readyState)try{if(a.status<200||a.status>=300)throw new Error("Twilio get failed: "+a.status+" - "+a.responseText);const e=JSON.parse(a.responseText);postResult({sid:e.sid,to:e.to,from:e.from,body:e.body,status:e.status,dateSent:e.date_sent||"",errorCode:e.error_code?String(e.error_code):""}),r()}catch(e){n(e)}},a.send()}))}(o,n);break;case"list":await async function(s,o){return new Promise(((r,n)=>{let a=e(o.accountSid.toString())+"/Messages.json";const i=[];s.to&&i.push("To="+encodeURIComponent(s.to.toString())),s.from&&i.push("From="+encodeURIComponent(s.from.toString())),s.dateSent&&i.push("DateSent="+encodeURIComponent(s.dateSent.toString())),i.length>0&&(a+="?"+i.join("&"));const d=t("GET",a,o);d.onreadystatechange=function(){if(4===d.readyState)try{if(d.status<200||d.status>=300)throw new Error("Twilio list failed: "+d.status+" - "+d.responseText);const e=JSON.parse(d.responseText);if(!e.messages||!Array.isArray(e.messages))throw new Error("Unexpected Twilio response: "+d.responseText);for(const t of e.messages)postResult({sid:t.sid,to:t.to,from:t.from,body:t.body,status:t.status,dateSent:t.date_sent||"",errorCode:t.error_code?String(t.error_code):""});r()}catch(e){n(e)}},d.send()}))}(r,n);break;case"delete":await async function(s,o){return new Promise(((r,n)=>{if(!s.sid)throw new Error("sid is required.");const a=t("DELETE",e(o.accountSid.toString())+"/Messages/"+encodeURIComponent(s.sid.toString())+".json",o);a.onreadystatechange=function(){if(4===a.readyState)try{if(204===a.status)r();else{if(a.status<200||a.status>=300)throw new Error("Twilio delete failed: "+a.status+" - "+a.responseText);r()}}catch(e){n(e)}},a.send()}))}(o,n);break;default:throw new Error("The method '"+s+"' is not supported.")}}(o,n,r,a)};
